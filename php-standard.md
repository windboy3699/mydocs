# PHP编码规范

本文档根据《阿里巴巴Java开发手册》改编

## 一、编程规约

### (一) 命名风格

1. 【强制】代码中的命名均不能以下划线或数字或美元符号开始，也不能以下划线或数字或美元符号结束。  
反例:\$_name / $\_\_name / $name\_ / name$ / $name\_\_ / $2a
2. 【强制】代码中的命名严禁使用拼音与英文混合的方式，更不允许直接使用中文的方式。  
说明:正确的英文拼写和语法可以让阅读者易于理解，避免歧义。注意，即使纯拼音命名方式 也要避免采用。  
正例:alibaba / taobao / youku / hangzhou 等国际通用的名称，可视同英文。  
反例:DaZhePromotion [打折] / getPingfenByName() [评分] / int 某变量 = 3
3. 【强制】类名使用 UpperCamelCase 风格，但以下情形例外:DO / BO / DTO / VO / AO / PO / UID等。  
正例:MarcoPolo / UserDO / XmlService / TcpUdpDeal / TaPromotion   
反例:macroPolo / UserDo / XMLService / TCPUDPDeal / TAPromotion
4. 【强制】方法名、参数名、成员变量、局部变量都统一使用 lowerCamelCase 风格，必须遵从 驼峰形式。  
正例: localValue / getHttpMessage() / inputUserId
5. 【强制】常量命名全部大写，单词间用下划线隔开，力求语义表达完整清楚，不要嫌名字长。  
正例:MAX_STOCK_COUNT  
反例:MAX_COUNT

6. 【强制】抽象类命名使用 Abstract 或 Base 开头;异常类命名使用 Exception 结尾;测试类 命名以它要测试的类的名称开始，以 Test 结尾。
7. 【强制】包名使用UpperCamelCase风格。包名统一使用单数形式，但是类名如果有复数含义，类名可以使用复数形式。
8. 【强制】杜绝完全不规范的缩写，避免望文不知义。  
反例:AbstractClass“缩写”命名成 AbsClass;condition“缩写”命名成 condi，此类随 意缩写严重降低了代码的可阅读性。
9. 【推荐】为了达到代码自解释的目标，任何自定义编程元素在命名时，使用尽量完整的单词 组合来表达其意。  
正例:在 JDK 中，表达原子更新的类名为:AtomicReferenceFieldUpdater。  
反例:变量 int a 的随意命名方式。
10. 【推荐】如果模块、接口、类、方法使用了设计模式，在命名时需体现出具体模式。   说明:将设计模式体现在名字中，有利于阅读者快速理解架构设计理念。  
正例:public class OrderFactory;  
     public class LoginProxy;   
     public class ResourceObserver;  
11. 【参考】Service/Model层方法命名规约:  
1) 获取单个对象的方法用get做前缀。
2) 获取多个对象的方法用list做前缀，复数形式结尾如:listObjects。
3) 获取统计值的方法用count做前缀。
4) 插入的方法用save/insert做前缀。
5) 删除的方法用remove/delete做前缀。
6) 修改的方法用update做前缀。

### (二) 代码格式
1. 【强制】class、function大括号的使用约定。左括号和右括号都单独一行。
2. 【强制】条件语句if/for/while/switch/do等大括号的使用约定。  
1\) 左大括号前不换行。  
2\) 左大括号后换行。  
3\) 右大括号前换行。  
4\) 右大括号后还有else等代码则不换行;表示终止的右大括号后必须换行。
3. 【强制】左小括号和字符之间不出现空格;同样，右小括号和字符之间也不出现空格;而左大 括号前需要空格。详见第 5 条下方正例提示。  
反例:if (空格a == b空格)

4. 【强制】if/for/while/switch/do 等保留字与括号之间都必须加空格。
5. 【强制】任何二目、三目运算符的左右两边都需要加一个空格。
说明:运算符包括赋值运算符=、逻辑运算符&&、加减乘除符号等。
6. 【强制】采用 4 个空格缩进，禁止使用 tab 字符。
说明:如果使用 tab 缩进，必须设置 1 个 tab 为 4 个空格。

正例: (涉及1-5点)  
```
public static function set(string $name)
{
    // 缩进 4 个空格
    $say = "hello";
    // 运算符的左右必须有一个空格
    $flag = 0;
    // 关键词 if 与括号之间必须有一个空格，括号内的 f 与左括号，0 与右括号不需要空格
    if ($flag == 0) {
        echo $say;
    }
    // 左大括号前加空格且不换行;左大括号后换行
    if ($flag == 1) {
        echo "world";
    // 右大括号前换行，右大括号后有 else，不用换行 
    } else {
        echo "ok";
    // 在右大括号后直接结束，则必须换行
    }
}
```

7. 【强制】注释的双斜线与注释内容之间有且仅有一个空格。  
正例:  
// 这是示例注释，请注意在双斜线之后有一个空格  
$say = "Hello World";

8. 【强制】单行字符数限制不超过 120 个，超出需要换行，换行时遵循如下原则:   
1\) 第二行相对第一行缩进 4 个空格，从第三行开始，不再继续缩进，参考示例。  
2\) 运算符与下文一起换行。  
3\) 方法调用的点符号与下文一起换行。  
4\) 方法调用中的多个参数需要换行时，在逗号后进行。   
5\) 在括号前不要换行，见反例。  
正例:  
```
$obj = new Object();
// 超过 120 个字符的情况下，换行缩进 4 个空格，点号和方法名称一起换行
$obj->append("zi")->append("xin")...
    ->append("huang")... 
    ->append("huang")... 
    ->append("huang");
```
反例:
```
$obj = new Object();
// 超过 120 个字符的情况下，不要在括号前换行
$obj->append("zi")->append("xin")...append
    ("huang");
// 参数很多的方法调用可能超过 120 个字符，不要在逗号前换行
method(args1, args2, args3, ...
  , argsX);
```

9. 【强制】方法参数在定义和传入时，多个参数逗号后边必须加空格。  
正例:下例中实参的 $args1，后边必须要有一个空格。function method($args1, $args2, $args3);

10.【强制】IDE的text file encoding设置为UTF-8; IDE中文件的换行符使用Unix格式， 不要使用 Windows 格式。
11. 【推荐】单个方法的总行数不超过 80 行。  
说明:包括方法签名、结束右大括号、方法内代码、注释、空行、回车及任何不可见字符的总 行数不超过 80 行。  
正例:代码逻辑分清红花和绿叶，个性和共性，绿叶逻辑单独出来成为额外方法，使主干代码  
更加清晰;共性逻辑抽取成为共性方法，便于复用和维护。

12. 【推荐】没有必要增加若干空格来使某一行的字符与上一行对应位置的字符对齐。  
13. 【推荐】不同逻辑、不同语义、不同业务的代码之间插入一个空行分隔开来以提升可读性。  
说明:任何情形，没有必要插入多个空行进行隔开。

### (三) 注释规约
1. 【强制】所有的类都必须添加创建者和创建日期。
2. 【强制】类、类属性、类方法的注释必须使用/**内容*/格式，不得使用 // xxx方式。
3. 【强制】方法内部单行注释，在被注释语句上方另起一行，使用//注释。方法内部多行注释
使用/* */注释，注意与代码对齐。
4. 【推荐】与其“半吊子”英文来注释，不如用中文注释把问题说清楚。专有名词与关键字保持 英文原文即可。
反例:“TCP 连接超时”解释成“传输控制协议连接超时”，理解反而费脑筋。
5. 【推荐】代码修改的同时，注释也要进行相应的修改，尤其是参数、返回值、异常、核心逻辑 等的修改。  
说明:代码与注释更新不同步，就像路网与导航软件更新不同步一样，如果导航软件严重滞后， 就失去了导航的意义。
6. 【参考】谨慎注释掉代码。在上方详细说明，而不是简单地注释掉。如果无用，则删除。   说明:代码被注释掉有两种可能性:1)后续会恢复此段代码逻辑。2)永久不用。前者如果没 有备注信息，难以知晓注释动机。后者建议直接删掉(代码仓库保存了历史代码)。

7. 【参考】对于注释的要求:第一、能够准确反应设计思想和代码逻辑;第二、能够描述业务含 义，使别的程序员能够迅速了解到代码背后的信息。完全没有注释的大段代码对于阅读者形同 天书，注释是给自己看的，即使隔很长时间，也能清晰理解当时的思路;注释也是给继任者看 的，使其能够快速接替自己的工作。
10. 【参考】好的命名、代码结构是自解释的，注释力求精简准确、表达到位。避免出现注释的
一个极端:过多过滥的注释，代码的逻辑一旦修改，修改注释是相当大的负担。  
反例:  
// put elephant into fridge  
put(elephant, fridge);  
方法名 put，加上两个有意义的变量名 elephant 和 fridge，已经说明了这是在干什么，语义清晰的代码不需要额外的注释。
11. 【参考】特殊注释标记，请注明标记人与标记时间。注意及时处理这些标记，通过标记扫描， 经常清理此类标记。线上故障有时候就是来源于这些标记处的代码。  
1\) 待办事宜(TODO):( 标记人，标记时间，[预计处理时间])  
表示需要实现，但目前还未实现的功能。只能应用于类，接口和方法(因为它是一个标签)。   
2\) 错误，不能工作(FIXME):(标记人，标记时间，[预计处理时间])  
在注释中用 FIXME 标记某代码是错误的，而且不能工作，需要及时纠正的情况。

## 二、MySQL 数据库

### (一) 建表规约

1. 【强制】表达是与否概念的字段，必须使用 is_xxx 的方式命名，数据类型是 unsigned tinyint (1 表示是，0 表示否)。  
说明:任何字段如果为非负数，必须是 unsigned。   
注意:数据库表示是与否的值，使用 tinyint 类型，坚持 is_xxx 的 命名方式是为了明确其取值含义与取值范围。
正例:表达逻辑删除的字段名 is_deleted，1 表示删除，0 表示未删除。
2. 【强制】表名、字段名必须使用小写字母或数字，禁止出现数字开头，禁止两个下划线中间只 出现数字。数据库字段名的修改代价很大，因为无法进行预发布，所以字段名称需要慎重考虑。   
说明:MySQL 在 Windows 下不区分大小写，但在 Linux 下默认是区分大小写。因此，数据库名、 表名、字段名，都不允许出现任何大写字母，避免节外生枝。   
正例:aliyun_admin，rdc_config，level3_name   
反例:AliyunAdmin，rdcConfig，level_3_name
3. 【强制】表名不使用复数名词。 说明:表名应该仅仅表示表里面的实体内容，不应该表示实体数量。
4. 【强制】禁用保留字，如 desc、range、match、delayed 等，请参考 MySQL 官方保留字。
5. 【强制】主键索引名为 pk_字段名;唯一索引名为 uk_字段名;普通索引名则为 idx_字段名。  
说明:pk_ 即 primary key;uk_ 即 unique key;idx_ 即 index 的简称。
6. 【强制】小数类型为 decimal，禁止使用 float 和 double。  
说明:float 和 double 在存储的时候，存在精度损失的问题，很可能在值的比较时，得到不 正确的结果。如果存储的数据范围超过 decimal 的范围，建议将数据拆成整数和小数分开存储。
7. 【强制】如果存储的字符串长度几乎相等，使用 char 定长字符串类型。
8. 【强制】varchar 是可变长字符串，不预先分配存储空间，长度不要超过 5000，如果存储长 度大于此值，定义字段类型为 text，独立出来一张表，用主键来对应，避免影响其它字段索引效率。

9. 【强制】表必备三字段:id, gmt_create, gmt_modified。   
说明:其中id必为主键，类型为int unsigned、单表时自增、步长为1。gmt_create, gmt_modified 的类型均为 datetime 类型，前者现在时表示主动创建，后者过去分词表示被动更新。
10. 【推荐】表的命名最好是加上“业务名称_表的作用”。  
正例:alipay_task / force_project / trade_config
11. 【推荐】库名与应用名称尽量一致。
12. 【推荐】如果修改字段含义或对字段表示的状态追加时，需要及时更新字段注释。
13. 【推荐】字段允许适当冗余，以提高查询性能，但必须考虑数据一致。冗余字段应遵循:   
1\)不是频繁修改的字段。  
2\)不是 varchar 超长字段，更不能是 text 字段。  
正例:商品类目名称使用频率高，字段长度短，名称基本一成不变，可在相关联的表中冗余存 储类目名称，避免关联查询。
14. 【推荐】单表行数超过 500 万行或者单表容量超过 2GB，才推荐进行分库分表。  
说明:如果预计三年后的数据量根本达不到这个级别，请不要在创建表时就分库分表。
15. 【参考】合适的字符存储长度，不但节约数据库表空间、节约索引存储，更重要的是提升检索速度。 其中无符号值可以避免误存负数，且扩大了表示范围。

### (二) 索引规约

1. 【强制】业务上具有唯一特性的字段，即使是多个字段的组合，也必须建成唯一索引。   
说明:不要以为唯一索引影响了 insert 速度，这个速度损耗可以忽略，但提高查找速度是明 显的;另外，即使在应用层做了非常完善的校验控制，只要没有唯一索引，根据墨菲定律，必然有脏数据产生。
2. 【强制】超过三个表禁止 join。需要 join 的字段，数据类型必须绝对一致;多表关联查询时， 保证被关联的字段需要有索引。  
说明:即使双表 join 也要注意表索引、SQL 性能。
3. 【强制】在 varchar 字段上建立索引时，必须指定索引长度，没必要对全字段建立索引，根据 实际文本区分度决定索引长度即可。  
说明:索引的长度与区分度是一对矛盾体，一般对字符串类型数据，长度为 20 的索引，区分
度会高达 90%以上，可以使用 count(distinct left(列名, 索引长度))/count(*)的区分度 来确定。
4. 【强制】页面搜索严禁左模糊或者全模糊，如果需要请走搜索引擎来解决。 说明:索引文件具有 B-Tree 的最左前缀匹配特性，如果左边的值未确定，那么无法使用此索引。
5. 【推荐】如果有 order by 的场景，请注意利用索引的有序性。order by 最后的字段是组合 索引的一部分，并且放在索引组合顺序的最后，避免出现 file_sort 的情况，影响查询性能。   
正例:where a=? and b=? order by c; 索引:a_b_c   
反例:索引中有范围查找，那么索引有序性无法利用，如:WHERE a>10 ORDER BY b; 索引 a_b 无法排序。
6. 【推荐】利用覆盖索引来进行查询操作，避免回表。  
说明:如果一本书需要知道第 11 章是什么标题，会翻开第 11 章对应的那一页吗?目录浏览 一下就好，这个目录就是起到覆盖索引的作用。  
正例:能够建立索引的种类分为主键索引、唯一索引、普通索引三种，而覆盖索引只是一种查 询的一种效果，用explain的结果，extra列会出现:using index。

7. 【推荐】利用延迟关联或者子查询优化超多分页场景。  
说明:MySQL 并不是跳过 offset 行，而是取 offset+N 行，然后返回放弃前 offset 行，返回 N 行，那当 offset 特别大的时候，效率就非常的低下，要么控制返回的总页数，要么对超过 特定阈值的页数进行 SQL 改写。  
正例:先快速定位需要获取的 id 段，然后再关联:  
SELECT a.* FROM 表 1 a, (select id from 表 1 where 条件 LIMIT 100000,20 ) b where a.id=b.id
8. 【推荐】SQL 性能优化的目标:至少要达到 range 级别，要求是 ref 级别，如果可以是 consts 最好。  
说明:  
1\)consts 单表中最多只有一个匹配行(主键或者唯一索引)，在优化阶段即可读取到数据。  
2\)ref 指的是使用普通的索引(normal index)。  
3\)range 对索引进行范围检索。  
反例:explain 表的结果，type=index，索引物理文件全扫描，速度非常慢，这个 index 级 别比较 range 还低，与全表扫描是小巫见大巫。
9. 【推荐】建组合索引的时候，区分度最高的在最左边。  
正例:如果 where a=? and b=? ，如果 a 列的几乎接近于唯一值，那么只需要单建 idx_a 索引即可。  
说明:存在非等号和等号混合时，在建索引时，请把等号条件的列前置。如:where c>? and d=? 那么即使 c 的区分度更高，也必须把 d 放在索引的最前列，即索引 idx_d_c。
10. 【推荐】防止因字段类型不同造成的隐式转换，导致索引失效。
11. 【参考】创建索引时避免有如下极端误解:   
1\)宁滥勿缺。认为一个查询就需要建一个索引。   
2\)宁缺勿滥。认为索引会消耗空间、严重拖慢更新和新增速度。  
3\)抵制惟一索引。认为业务的惟一性一律需要在应用层通过“先查后插”方式解决。

### (三) SQL 语句

1. 【强制】不要使用 count(列名)或 count(常量)来替代 count(*)，count(*)是 SQL92 定义的 标准统计行数的语法，跟数据库无关，跟 NULL 和非 NULL 无关。  
说明:count(*)会统计值为 NULL 的行，而 count(列名)不会统计此列为 NULL 值的行。
2. 【强制】count(distinct col) 计算该列除 NULL 之外的不重复行数，注意 count(distinct col1, col2) 如果其中一列全为NULL，那么即使另一列有不同的值，也返回为0。
3. 【强制】当某一列的值全是 NULL 时，count(col)的返回结果为 0，但 sum(col)的返回结果为 NULL，因此使用 sum()时需注意 NPE 问题。   
正例:可以使用如下方式来避免sum的NPE问题:SELECT IF(ISNULL(SUM(g)),0,SUM(g)) FROM table;
4. 【强制】使用 ISNULL()来判断是否为 NULL 值。 说明:NULL 与任何值的直接比较都为 NULL。  
1\) NULL<>NULL的返回结果是NULL，而不是false。   
2\) NULL=NULL的返回结果是NULL，而不是true。   
3\) NULL<>1的返回结果是NULL，而不是true。
5. 【强制】 在代码中写分页查询逻辑时，若 count 为 0 应直接返回，避免执行后面的分页语句。
6. 【强制】不得使用外键与级联，一切外键概念必须在应用层解决。   
说明:以学生和成绩的关系为例，学生表中的 student_id 是主键，那么成绩表中的 student_id 则为外键。如果更新学生表中的 student_id，同时触发成绩表中的 student_id 更新，即为 级联更新。外键与级联更新适用于单机低并发，不适合分布式、高并发集群;级联更新是强阻 塞，存在数据库更新风暴的风险;外键影响数据库的插入速度。

7. 【强制】禁止使用存储过程，存储过程难以调试和扩展，更没有移植性。
8. 【强制】数据订正(特别是删除、修改记录操作)时，要先 select，避免出现误删除，确认
无误才能执行更新语句。
9. 【推荐】in 操作能避免则避免，若实在避免不了，需要仔细评估 in 后边的集合元素数量，控制在 1000 个之内。
10. 【参考】如果有国际化需要，所有的字符存储与表示，均以 utf-8 编码，注意字符统计函数
的区别。
说明:  
SELECT LENGTH("轻松工作"); 返回为12  
SELECT CHARACTER_LENGTH("轻松工作"); 返回为4   
如果需要存储表情，那么选择 utf8mb4 来进行存储，注意它与 utf-8 编码的区别。
11. 【参考】TRUNCATE TABLE 比 DELETE 速度快，且使用的系统和事务日志资源少，但 TRUNCATE 无事务且不触发 trigger，有可能造成事故，故不建议在开发代码中使用此语句。   
说明:TRUNCATE TABLE 在功能上与不带 WHERE 子句的 DELETE 语句相同。