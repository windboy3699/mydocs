# 微服务架构

## 介绍

假设我们正在开发一个在线购物App，需要实现一个商品详情页来展示商品信息。

商品详情页一般包含如下信息：
**基本信息、商品详细、用户评论、用户提问、优惠活动、推荐商品**

传统的数据获取，用户移动客户端发送一个HTTP请求(GET api.mall.com/product/detail/productId=xxx)到服务器，负载均衡服务器把请求转发到某个后端服务器程序执行多个查询，最后把多个查询结果返回给客户端，这个接口一个人做了所有事情。

采用微服务架构，页面上的数据会分布在不同的微服务中，例如：

* 基本信息 -> 商品服务
* 详细信息 -> 商品服务
* 用户评论 -> 评论服务
* 用户提问 -> 问答服务
* 优惠活动 -> 优惠服务
* 推荐商品 -> 推荐服务

接下来，我们需要决定客户端如何访问这些服务，请看下面这几种方式

### 客户端到微服务直接通信

理论上说，一个客户端可以直接给多个微服务中的任何一个发起请求。每一个微服务都会有一个对外服务端(https://servicename.api.mall.com)。这个URL可能会映射到微服务的负载均衡上，它再转发到具体节点上。展示一个商品详情，客户端需要向上述微服务逐个发送请求。

这个方案有很多困难和限制：

其中一个问题是客户端的需求量与每个微服务暴露的细粒度API数量的不匹配，客户端访问商品页面，需要6次单独请求。在更复杂的场景中，可能会需要更多次请求，在公网上这样会很没有效率。

另一个问题是客户端直接请求微服务的协议可能并不是web友好型。一个服务可能是用Thrift的RPC协议，而另一个服务可能是用AMQP消息协议，只适合内部使用。应该采用类似HTTP或者WEBSocket协议。

这个方案的另一个缺点是很难重构微服务。随着时间的推移，我们可能需要改变系统微服务目前的切分方案。例如，我们可能需要将两个服务合并或者将一个服务拆分为多个。但是，如果客户端直接与微服务交互，那么这种重构就很难实施。

由于上述三个问题的原因，客户端直接与微服务端通信的方式很少在实际中使用。

### 采用一个API Gateway

通常来说，一个更好的解决办法是采用API Gateway的方式。API Gateway是一个服务器，也可以说是进入系统的唯一节点。这跟面向对象设计模式中的Facade模式很像。API Gateway封装内部系统的架构，并且提供API给各个客户端。它还可能有其他功能，如授权、监控、统计、负载均衡、缓存、聚合等。

API Gateway负责请求转发、合成和协议转换。所有来自客户端的请求都要先经过API Gateway，然后路由这些请求到对应的微服务。API Gateway可以通过调用多个微服务来处理一个请求以及聚合多个服务的结果。它可以在web协议与内部使用的非Web友好型协议间进行转换，如HTTP、WebSocket、RPC。

API Gateway可以提供给客户端一个定制化的API。它暴露一个粗粒度API给移动客户端。以商品页这个使用场景为例。API Gateway提供一个服务提供点（/product/detail?productId=xxx）使得客户端可以在一个请求中检索到产品最终页的全部数据。同时也可以增加Type参数，针对不同类型设备调用所需服务返回所需结果。API Gateway通过调用多个服务来处理这一个请求并返回结果，涉及商品信息、推荐、评论等。

### API Gateway优缺点

如你所料，采用API Gateway也是优缺点并存的。API Gateway的一个最大好处是封装应用内部结构。相比起来调用指定的服务，客户端直接跟gateway交互更简单点。API Gateway提供给每一个客户端一个特定API，这样减少了客户端与服务器端的通信次数，也简化了客户端代码。

API Gateway也有一些缺点。它是一个高可用的组件，必须要开发、部署和管理。还有一个问题，它可能成为开发的一个瓶颈。开发者必须更新API Gateway来提供新服务提供点来支持新暴露的微服务。更新API Gateway时必须越轻量级越好。否则，开发者将因为更新Gateway而排队列。但是，除了这些缺点，对于大部分的应用，采用API Gateway的方式都是有效的。

## API Gateway实现

![微服务架构.png](https://raw.githubusercontent.com/windboy3699/mydocs/master/images/soa.png)

#### 框架选择

API-Gateway使用easyswoole框架，这个框架的很多特性，比如：丰富的通信协议，异步并行、协程、RPC框架、API支持、微服务等都是我们需要的功能。

各微服务也使用easyswoole，这样网关和微服务之间的调用可以使用框架自带RPC。

网关对外提供HTTP方式调用，对于公司内部的其他系统调用我们的微服务，前期先使用HTTP调用。如果要实现内部其他系统RPC调用网关接口，要么其他系统也是swoole框架，要么把swoole框架的RPC库剥离出来，要么使用其他RPC框架比如phprpc、thrift，把新的rpc框架引入到网关和内部其他系统。

#### Gateway调用多个服务

Gateway部分接口可能聚合了多个服务，需要调用多个服务，如果调用次数过多，性能会比较低。因此，考虑使用swoole的并发执行。

